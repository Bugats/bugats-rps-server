<!DOCTYPE html>
<html lang="lv">
<head>
  <meta charset="UTF-8" />
  <title>Bugats RPS (online)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #020617;
      --panel: rgba(15, 23, 42, .5);
      --accent: #38bdf8;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      background: radial-gradient(circle at top, #0f172a 0%, #020617 55%, #000 100%);
      color: #e2e8f0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      min-height: 100vh;
      display: flex;
      gap: 1rem;
      padding: 1rem;
    }
    #app {
      width: 100%;
      max-width: 1100px;
      margin: 0 auto;
      display: flex;
      gap: 1rem;
    }
    .game {
      flex: 1;
      background: rgba(15, 23, 42, .4);
      border: 1px solid rgba(148, 163, 184, .1);
      border-radius: 16px;
      padding: 1rem;
    }
    .sidebar {
      width: 290px;
      background: rgba(2, 6, 23, 0.35);
      border: 1px solid rgba(148,163,184,.12);
      border-radius: 16px;
      padding: 1rem;
      display: flex;
      flex-direction: column;
      gap: .6rem;
    }
    h1 { margin: 0 0 .35rem 0; font-size: 1.05rem; }
    #status { color: #94a3b8; font-size: .8rem; margin-left: .35rem; }
    #rps-arena {
      display: flex;
      gap: 1rem;
      justify-content: center;
      align-items: center;
      margin-top: .75rem;
      margin-bottom: .5rem;
    }
    .rps-card {
      width: 120px;
      height: 120px;
      background: rgba(15, 23, 42, .2);
      border: 1px solid rgba(148, 163, 184, .3);
      border-radius: 15px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      gap: .25rem;
      font-size: 2.4rem;
      transition: .25s;
      position: relative;
    }
    .rps-name {
      font-size: .75rem;
      color: #94a3b8;
    }
    .rps-card.reveal {
      transform: scale(1.03);
      box-shadow: 0 15px 35px rgba(0,0,0,.25);
    }
    #rps-winner {
      text-align: center;
      font-weight: 600;
      display: none;
      margin-top: .4rem;
    }
    .moves {
      display: flex;
      gap: .4rem;
      justify-content: center;
    }
    .move-btn {
      background: rgba(15, 23, 42, .35);
      border: 1px solid rgba(148, 163, 184, .3);
      border-radius: 8px;
      padding: .35rem .6rem;
      cursor: pointer;
      font-size: 1.5rem;
      transition: .2s;
    }
    .move-btn:hover {
      background: rgba(148, 163, 184, .12);
    }
    .card {
      background: rgba(15, 23, 42, .35);
      border: 1px solid rgba(148, 163, 184, .15);
      border-radius: 12px;
      padding: .45rem .5rem .35rem;
    }
    #nick-input {
      width: 100%;
      background: rgba(15,23,42,.3);
      border: 1px solid rgba(148,163,184,.25);
      border-radius: 8px;
      padding: .25rem .35rem;
      color: #e2e8f0;
      margin-top: .25rem;
    }
    .lb-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: .75rem;
      padding: .25rem .2rem;
      border-radius: 6px;
    }
    .lb-item.me { background: rgba(56,189,248,.08); }
    .rooms {
      display: flex;
      gap: .35rem;
      margin-top: .35rem;
    }
    .room-btn {
      flex: 1;
      background: rgba(15, 23, 42, .25);
      border: 1px solid rgba(148,163,184,.25);
      border-radius: 6px;
      text-align: center;
      font-size: .7rem;
      padding: .25rem 0;
      cursor: pointer;
    }
    .room-btn.active {
      border-color: #38bdf8;
      background: rgba(56,189,248,.08);
    }
    #online-rooms {
      font-size: .68rem;
      color: #94a3b8;
      margin-top: .25rem;
    }
    #last-btn {
      width: 100%;
      margin-top: .35rem;
      background: rgba(220, 38, 38, .18);
      border: 1px solid rgba(248, 113, 113, .35);
      border-radius: 7px;
      padding: .35rem 0;
      text-align: center;
      font-size: .7rem;
      cursor: pointer;
    }
    @media (max-width: 950px) {
      #app { flex-direction: column; }
      .sidebar { width: 100%; flex-direction: row; flex-wrap: wrap; }
      .game { order: -1; }
    }
  </style>
</head>
<body>
  <div id="app">
    <div class="game">
      <h1>Bugats RPS <span id="status">(nav savienojuma)</span></h1>
      <div id="rps-arena">
        <div id="rps-p1" class="rps-card">
          <div class="rps-name" id="rps-p1-name">Gaida...</div>
          <div id="rps-p1-move">‚ùî</div>
          <small id="rps-p1-score" style="font-size:.6rem;color:#94a3b8;">0</small>
        </div>
        <div style="font-weight:700;">VS</div>
        <div id="rps-p2" class="rps-card">
          <div class="rps-name" id="rps-p2-name">Gaida...</div>
          <div id="rps-p2-move">‚ùî</div>
          <small id="rps-p2-score" style="font-size:.6rem;color:#94a3b8;">0</small>
        </div>
      </div>
      <div id="rps-winner"></div>

      <div class="moves">
        <div class="move-btn" data-move="rock">ü™®</div>
        <div class="move-btn" data-move="paper">üìÑ</div>
        <div class="move-btn" data-move="scissors">‚úÇÔ∏è</div>
      </div>
      <small style="text-align:center;color:#94a3b8;margin-top:.4rem;">Piemƒìrs: pirmais lƒ´dz 2 uzvarƒÅm (best of 3)</small>
    </div>

    <div class="sidebar">
      <div class="card">
        <strong>Mans niks</strong>
        <input id="nick-input" maxlength="20" />
        <small style="font-size:.7rem;color:#94a3b8;">Mainƒ´t saprƒÅtƒ´gi üòâ</small>
      </div>

      <div class="card">
        <strong>Istaba</strong>
        <div class="rooms">
          <div class="room-btn" data-room="1">Room 1</div>
          <div class="room-btn" data-room="2">Room 2</div>
          <div class="room-btn" data-room="3">Room 3</div>
        </div>
        <div id="online-rooms">1:0 ¬∑ 2:0 ¬∑ 3:0</div>
      </div>

      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center;">
          <strong>TOP</strong>
          <span id="online" style="font-size:.7rem;color:#94a3b8;">Online: 0</span>
        </div>
        <div id="leaderboard" style="display:flex;flex-direction:column;gap:.25rem;margin-top:.25rem;"></div>
      </div>

      <div class="card" style="flex:1;min-height:120px;">
        <strong>Pƒìdƒìjie maƒçi</strong>
        <div id="history" style="margin-top:.3rem;max-height:230px;overflow-y:auto;font-size:.7rem;display:flex;flex-direction:column;gap:.25rem;"></div>
        <div id="last-btn">PƒìdƒìjƒÅ partija üéØ</div>
      </div>
    </div>
  </div>

  <script>
    // TE IEVIETO SAVU ƒ´sto Render WS adresi
    // piem.: const WS_URL = "wss://bugats-rps.onrender.com";
    const WS_URL = "wss://bugats-rps.onrender.com";

    const state = {
      ws: null,
      myId: localStorage.getItem("rps_id") || Math.random().toString(36).slice(2,9),
      myName: localStorage.getItem("rps_nick") || ("SpƒìlƒìtƒÅjs-" + Math.floor(Math.random()*999)),
      room: localStorage.getItem("rps_room") || "1",
      inMatch: false,
      canMove: false
    };
    // saglabƒÅjam id, lai paliek tas pats
    localStorage.setItem("rps_id", state.myId);

    // elementi
    const p1name = document.getElementById("rps-p1-name");
    const p2name = document.getElementById("rps-p2-name");
    const p1move = document.getElementById("rps-p1-move");
    const p2move = document.getElementById("rps-p2-move");
    const p1score = document.getElementById("rps-p1-score");
    const p2score = document.getElementById("rps-p2-score");
    const winnerEl = document.getElementById("rps-winner");
    const statusEl = document.getElementById("status");
    const nickInput = document.getElementById("nick-input");
    const lbEl = document.getElementById("leaderboard");
    const onlineEl = document.getElementById("online");
    const historyEl = document.getElementById("history");
    const onlineRoomsEl = document.getElementById("online-rooms");
    const lastBtn = document.getElementById("last-btn");
    const roomBtns = document.querySelectorAll(".room-btn");

    nickInput.value = state.myName;
    setActiveRoomBtn();

    connect();

    function connect() {
      const ws = new WebSocket(WS_URL);
      state.ws = ws;

      ws.addEventListener("open", () => {
        statusEl.textContent = "(savienots, gaida pretinieku)";
        ws.send(JSON.stringify({
          type: "hello",
          id: state.myId,
          name: state.myName,
          room: state.room
        }));
      });

      ws.addEventListener("message", (ev) => {
        let msg;
        try { msg = JSON.parse(ev.data); } catch(e) { return; }
        handleMsg(msg);
      });

      ws.addEventListener("close", () => {
        statusEl.textContent = "(nav savienojuma)";
        setTimeout(connect, 2000);
      });
    }

    function handleMsg(msg) {
      switch (msg.type) {
        case "online":
          onlineEl.textContent = "Online: " + (msg.total || 0);
          if (msg.rooms) {
            onlineRoomsEl.textContent = `1:${msg.rooms["1"]||0} ¬∑ 2:${msg.rooms["2"]||0} ¬∑ 3:${msg.rooms["3"]||0}`;
          }
          break;

        case "leaderboard":
          renderLeaderboard(msg.list || []);
          break;

        case "waiting":
          statusEl.textContent = "(savienots, gaida pretinieku)";
          break;

        case "matchStart":
          state.inMatch = true;
          state.canMove = true;
          p1name.textContent = msg.p1.name;
          p2name.textContent = msg.p2.name;
          p1move.textContent = "‚ùî";
          p2move.textContent = "‚ùî";
          p1score.textContent = msg.p1.score ?? 0;
          p2score.textContent = msg.p2.score ?? 0;
          winnerEl.style.display = "none";
          statusEl.textContent = "(cƒ´≈Üa notiek)";
          break;

        case "rps-show":
          p1move.textContent = "‚ùî";
          p2move.textContent = "‚ùî";
          winnerEl.style.display = "none";
          break;

        case "rps-reveal":
          revealMoves(msg);
          break;

        case "matchEnd":
          winnerEl.textContent = "ü•á Uzvarƒìja: " + msg.winner;
          winnerEl.style.display = "block";
          state.inMatch = false;
          state.canMove = false;
          addHistory(msg);
          statusEl.textContent = "(gaida jaunu pretinieku)";
          break;

        case "opponentLeft":
          statusEl.textContent = "(pretinieks aizgƒÅja, gaida jaunu)";
          p2name.textContent = "Gaida...";
          p2move.textContent = "‚ùî";
          p2score.textContent = "0";
          state.inMatch = false;
          state.canMove = false;
          break;

        case "lastGameAck":
          statusEl.textContent = "(pƒìdƒìjƒÅ partija aktivizƒìta)";
          break;

        case "blockedSelf":
          statusEl.textContent = "(gaida citu spƒìlƒìtƒÅju)";
          break;

        case "error":
          alert(msg.message);
          break;
      }
    }

    function revealMoves(msg) {
      const c1 = document.getElementById("rps-p1");
      const c2 = document.getElementById("rps-p2");
      p1move.textContent = emojiFromMove(msg.p1.move);
      p2move.textContent = emojiFromMove(msg.p2.move);
      p1score.textContent = msg.p1.score;
      p2score.textContent = msg.p2.score;
      c1.classList.add("reveal");
      c2.classList.add("reveal");

      if (msg.winner) {
        winnerEl.textContent = "üéâ " + msg.winner + " uzvarƒìja!";
      } else {
        winnerEl.textContent = "‚öñ Neiz≈°ƒ∑irts";
      }
      winnerEl.style.display = "block";

      setTimeout(() => {
        c1.classList.remove("reveal");
        c2.classList.remove("reveal");
      }, 1200);

      // gatavs nƒÅkamajam gƒÅjienam
      state.canMove = true;
    }

    function emojiFromMove(move) {
      if (move === "rock") return "ü™®";
      if (move === "paper") return "üìÑ";
      if (move === "scissors") return "‚úÇÔ∏è";
      return "‚ùî";
    }

    document.querySelectorAll(".move-btn").forEach(btn => {
      btn.addEventListener("click", () => {
        if (!state.inMatch || !state.canMove) return;
        const move = btn.dataset.move;
        state.canMove = false;
        state.ws.send(JSON.stringify({
          type: "move",
          move,
          id: state.myId
        }));
      });
    });

    nickInput.addEventListener("change", () => {
      const v = nickInput.value.trim();
      if (!v) return;
      state.myName = v;
      localStorage.setItem("rps_nick", v);
      if (state.ws && state.ws.readyState === 1) {
        state.ws.send(JSON.stringify({ type: "setName", name: v, id: state.myId }));
      }
    });

    lastBtn.addEventListener("click", () => {
      if (state.ws && state.ws.readyState === 1) {
        state.ws.send(JSON.stringify({ type: "lastGame" }));
      }
    });

    roomBtns.forEach(btn => {
      btn.addEventListener("click", () => {
        const r = btn.dataset.room;
        if (r === state.room) return;
        state.room = r;
        localStorage.setItem("rps_room", r);
        setActiveRoomBtn();
        if (state.ws && state.ws.readyState === 1) {
          state.ws.send(JSON.stringify({ type: "changeRoom", room: r }));
          statusEl.textContent = "(maina istabu...)";
        }
      });
    });

    function setActiveRoomBtn() {
      roomBtns.forEach(b => {
        b.classList.toggle("active", b.dataset.room === state.room);
      });
    }

    function renderLeaderboard(list) {
      lbEl.innerHTML = "";
      list.forEach(p => {
        const row = document.createElement("div");
        row.className = "lb-item" + (p.id === state.myId ? " me" : "");
        row.innerHTML = `<span>${p.name}</span><span>${p.score}</span>`;
        lbEl.appendChild(row);
      });
    }

    function addHistory(msg) {
      const item = document.createElement("div");
      item.textContent = `${msg.p1} (${msg.p1score}) vs ${msg.p2} (${msg.p2score}) ‚Üí ${msg.winner}`;
      historyEl.prepend(item);
      if (historyEl.children.length > 50) {
        historyEl.removeChild(historyEl.lastChild);
      }
    }
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="lv">
<head>
  <meta charset="UTF-8" />
  <title>Bugats RPS (online)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #0f172a;
      --panel: rgba(15,23,42,.65);
      --border: rgba(148,163,184,.25);
      --text: #e2e8f0;
      --accent: #22c55e;
      --danger: #f43f5e;
      --warn: #f97316;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      background: radial-gradient(circle at top, #0f172a 0%, #020617 60%);
      color: var(--text);
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }
    .wrap {
      display: flex;
      width: 100%;
      gap: 1rem;
      padding: 1rem;
      align-items: flex-start;
    }
    .left {
      flex: 1.4;
      background: rgba(2,6,23,.4);
      border: 1px solid rgba(148,163,184,.05);
      border-radius: 20px;
      padding: 1rem 1.25rem 1.5rem;
      position: relative;
      overflow: hidden;
      min-width: 310px;
    }
    .right {
      width: 320px;
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }
    .card {
      background: rgba(2,6,23,.4);
      border: 1px solid rgba(148,163,184,.05);
      border-radius: 16px;
      padding: 1rem;
    }
    h1 {
      margin: 0 0 .5rem;
      font-size: 1.5rem;
      display: flex;
      align-items: center;
      gap: .5rem;
    }
    .status { font-size: .8rem; opacity: .7; }

    .arena {
      margin-top: .6rem;
      display: flex;
      justify-content: center;
      gap: 1.8rem;
      align-items: center;
      flex-wrap: wrap;
    }
    .player-box {
      width: 180px;
      height: 200px;
      border: 1px solid rgba(148,163,184,.3);
      border-radius: 28px;
      background: radial-gradient(circle at 40% 20%, rgba(148,163,184,.2), rgba(15,23,42,.12));
      text-align: center;
      position: relative;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      gap: .25rem;
      padding-top: .6rem;
    }
    .player-name { font-weight: 600; margin-top: .25rem; }
    .player-avatar {
      position: absolute;
      top: 8px;
      right: 8px;
      width: 44px;
      height: 44px;
      border-radius: 9999px;
      border: 2px solid rgba(255,255,255,.35);
      background: rgba(15,23,42,.4);
      background-size: cover;
      background-position: center;
    }
    .question { font-size: 4.2rem; line-height: 1; margin-top: 1.15rem; }
    .score-small { margin-top: .35rem; font-size: .75rem; opacity: .7; }
    .vs { font-weight: 700; font-size: 1.25rem; opacity: .85; }

    .moves {
      margin-top: 1.1rem;
      display: flex;
      gap: .75rem;
      justify-content: center;
    }
    .move-btn {
      width: 70px;
      height: 70px;
      border-radius: 1.2rem;
      background: rgba(15,23,42,.4);
      border: 1px solid rgba(148,163,184,.18);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: .15s;
    }
    .move-btn:hover { background: rgba(148,163,184,.09); transform: translateY(-2px); }
    .icon-move {
      width: 42px;
      height: 42px;
      background: rgba(15,23,42,.55);
      border: 1px solid rgba(148,163,184,.35);
      border-radius: 14px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.25rem;
    }

    .ready-hint {
      text-align:center;
      font-size:.72rem;
      opacity:.7;
      margin-top:.4rem;
      display:flex;
      gap:.4rem;
      justify-content:center;
      flex-wrap:wrap;
    }
    .btn {
      border: none;
      background: rgba(34,197,94,.18);
      color: #ecfdf3;
      padding: .45rem .8rem;
      border-radius: .6rem;
      cursor: pointer;
      font-size:.7rem;
    }
    .btn[disabled] {
      opacity:.4;
      cursor:not-allowed;
    }
    .btn-danger { background: rgba(244,63,94,.17); }

    #mustReady {
      display:none;
      width:100%;
      text-align:center;
      font-size:.78rem;
      color:#fde68a;
      margin-top:.25rem;
      animation: pulseReady 1s ease infinite;
    }
    @keyframes pulseReady {
      0%{opacity:0.2;}
      50%{opacity:1;}
      100%{opacity:0.2;}
    }

    #msg {
      position: absolute;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(15,23,42,.8);
      border: 1px solid rgba(148,163,184,.25);
      border-radius: 9999px;
      padding: .35rem .85rem;
      font-size: .8rem;
      display: none;
      z-index: 30;
    }

    #fight-anim {
      position: absolute;
      top: 105px;
      left: 50%;
      transform: translateX(-50%);
      width: 260px;
      height: 120px;
      pointer-events: none;
      display: none;
      z-index: 20;
    }
    .fight-wrap { position: relative; width: 100%; height: 100%; }
    .fight-icon {
      position: absolute;
      top: 20px;
      width: 80px;
      height: 80px;
      background-size: contain;
      background-repeat: no-repeat;
      background-position: center;
      filter: drop-shadow(0 4px 10px rgba(0,0,0,.5));
    }
    .fight-left { left: 0; }
    .fight-right { right: 0; }
    .fight-wrap.rock-smash .fight-left,
    .fight-wrap.rock-smash .fight-right { animation: smash 1s ease; }
    @keyframes smash { 0%{transform:scale(1);} 50%{transform:scale(1.25);} 100%{transform:scale(1);} }

    .name-input {
      width: 100%;
      padding: .55rem .7rem;
      border-radius: .7rem;
      border: 1px solid rgba(148,163,184,.22);
      background: rgba(15,23,42,.35);
      color: var(--text);
      outline: none;
    }
    .label-sm { font-size: .75rem; opacity: .65; margin-bottom: .35rem; display:block; }

    .smallflex { display:flex; gap:.4rem; align-items:center; }
    .queue-box { font-size:.72rem; line-height:1.35; }
    .queue-title { font-weight:600; margin-top:.35rem; margin-bottom:.15rem; }
    .queue-empty { opacity:.5; }

    #logs { max-height:140px; overflow-y:auto; }

    /* PLƒÄN≈†ETES */
    @media (max-width: 930px){
      .wrap { flex-direction: column; }
      .right {
        width: 100%;
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(240px,1fr));
        gap: 1rem;
      }
      .arena {
        flex-wrap: nowrap;
        gap: 1rem;
      }
      .player-box {
        width: 150px;
        height: 180px;
      }
      #fight-anim { top: 150px; }
    }

    /* ƒªOTI ≈†AURI TELEFONI */
    @media (max-width: 420px){
      .arena {
        flex-wrap: nowrap;
        gap: .6rem;
      }
      .player-box {
        width: 135px;
        height: 170px;
      }
      .question { font-size: 3.5rem; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="left">
      <h1>Bugats RPS <span id="status" class="status">(nav savienojuma)</span></h1>

      <div id="fight-anim">
        <div class="fight-wrap" id="fight-wrap">
          <div class="fight-icon fight-left" id="fight-left"></div>
          <div class="fight-icon fight-right" id="fight-right"></div>
        </div>
      </div>

      <div class="arena">
        <div class="player-box" id="p1box">
          <div class="player-avatar" id="avatar1"></div>
          <div class="player-name" id="p1name">Gaida...</div>
          <div class="question" id="p1move">?</div>
          <div class="score-small" id="p1round">0</div>
        </div>
        <div class="vs" id="vslabel">VS</div>
        <div class="player-box" id="p2box">
          <div class="player-avatar" id="avatar2"></div>
          <div class="player-name" id="p2name">Gaida...</div>
          <div class="question" id="p2move">?</div>
          <div class="score-small" id="p2round">0</div>
        </div>
      </div>

      <div class="moves">
        <div class="move-btn" data-move="rock"><div class="icon-move">üóø</div></div>
        <div class="move-btn" data-move="paper"><div class="icon-move">üìÑ</div></div>
        <div class="move-btn" data-move="scissors"><div class="icon-move">‚úÇÔ∏è</div></div>
      </div>

      <div class="ready-hint">
        <button id="readyBtn" class="btn">Es esmu gatavs ‚úÖ</button>
        <button id="lastBtn" class="btn btn-danger">PƒìdƒìjƒÅ partija</button>
        <span id="roundInfo"></span>
      </div>
      <div id="mustReady">‚ö† Spied ‚ÄúEs esmu gatavs‚Äù, lai sƒÅktu maƒçu!</div>

      <div id="winnerLine" style="text-align:center;margin-top:6px;font-size:.8rem;min-height:1.2rem;"></div>

      <div id="msg"></div>
    </div>

    <div class="right">
      <div class="card">
        <label class="label-sm">Mans niks</label>
        <div style="display:flex; gap:.4rem;">
          <input id="nick" class="name-input" placeholder="Bugats" style="flex:1;" />
          <button id="saveNick" class="btn" type="button">OK</button>
        </div>
        <small style="opacity:.6;font-size:.7rem;">Mainƒ´t saprƒÅtƒ´gi üòâ</small>
      </div>

      <div class="card">
        <div class="smallflex">
          <div style="flex:1;">TOP</div>
          <div id="onlineInfo" style="font-size:.7rem;opacity:.6;">Online: 0</div>
        </div>
        <div id="toplist" style="margin-top:.4rem;"></div>
      </div>

      <div class="card">
        <div class="smallflex" style="margin-bottom:.5rem;">
          <div style="flex:1;">Istaba</div>
          <select id="roomSel">
            <option value="1">Istaba 1</option>
            <option value="2">Istaba 2</option>
            <option value="3">Istaba 3</option>
          </select>
        </div>
        <label class="label-sm">AvatƒÅrs</label>
        <input type="file" id="avatarFile" accept="image/*" />

        <div style="margin-top:.6rem;">
          <div class="queue-title">Istabu rindas</div>
          <div class="queue-box">
            <strong>1:</strong> <span id="q1" class="queue-empty">tuk≈°a</span><br>
            <strong>2:</strong> <span id="q2" class="queue-empty">tuk≈°a</span><br>
            <strong>3:</strong> <span id="q3" class="queue-empty">tuk≈°a</span>
          </div>
        </div>
      </div>

      <div class="card">
        <div style="font-size:.75rem;opacity:.5;">Pƒìdƒìjie maƒçi</div>
        <div id="logs" style="font-size:.72rem;margin-top:.4rem;"></div>
      </div>
    </div>
  </div>

  <script>
    // MAINI ≈†O UZ SAVU RENDER URL
    const WS_URL = "wss://bugats-rps.onrender.com";

    let ws;
    let myId = localStorage.getItem("rps_id") || null;
    let myName = localStorage.getItem("rps_name") || "Bugats";
    let myRoom = localStorage.getItem("rps_room") || "1";
    let myAvatar = localStorage.getItem("rps_avatar") || null;

    const statusEl = document.getElementById("status");
    const nickEl = document.getElementById("nick");
    const roomSel = document.getElementById("roomSel");
    const avatarFile = document.getElementById("avatarFile");

    const p1name = document.getElementById("p1name");
    const p2name = document.getElementById("p2name");
    const p1move = document.getElementById("p1move");
    const p2move = document.getElementById("p2move");
    const p1round = document.getElementById("p1round");
    const p2round = document.getElementById("p2round");
    const avatar1 = document.getElementById("avatar1");
    const avatar2 = document.getElementById("avatar2");

    const roundInfo = document.getElementById("roundInfo");
    const readyBtn = document.getElementById("readyBtn");
    const lastBtn = document.getElementById("lastBtn");
    const logs = document.getElementById("logs");
    const toplistEl = document.getElementById("toplist");
    const onlineInfoEl = document.getElementById("onlineInfo");
    const msg = document.getElementById("msg");
    const winnerLine = document.getElementById("winnerLine");
    const mustReady = document.getElementById("mustReady");

    const q1 = document.getElementById("q1");
    const q2 = document.getElementById("q2");
    const q3 = document.getElementById("q3");

    const fightBox = document.getElementById("fight-anim");
    const fightWrap = document.getElementById("fight-wrap");
    const fightLeft = document.getElementById("fight-left");
    const fightRight = document.getElementById("fight-right");

    let countdownTimer = null;
    let countdownLeft = 0;
    let iAmReady = false;

    nickEl.value = myName;
    roomSel.value = myRoom;

    function connect() {
      ws = new WebSocket(WS_URL);
      ws.onopen = () => {
        statusEl.textContent = "(savienots, gaida)";
        ws.send(JSON.stringify({
          type: "hello",
          id: myId,
          name: myName,
          room: myRoom,
          avatar: myAvatar
        }));
      };
      ws.onclose = () => {
        statusEl.textContent = "(atvienots)";
        setTimeout(connect, 2500);
      };
      ws.onmessage = (ev) => {
        const data = JSON.parse(ev.data);
        handleMsg(data);
      };
    }
    connect();

    function handleMsg(data) {
      switch (data.type) {
        case "online":
          onlineInfoEl.textContent = `Online: ${data.total} | 1:${data.rooms["1"]} 2:${data.rooms["2"]} 3:${data.rooms["3"]}`;
          break;

        case "queues":
          renderQueues(data.rooms);
          break;

        case "leaderboard":
          renderTop(data.list);
          break;

        case "matchStart":
          iAmReady = false;
          readyBtn.disabled = false;
          mustReady.style.display = "block";
          showMsg("Atrada pretinieku istabƒÅ " + data.room);
          setP1(data.p1);
          setP2(data.p2);
          p1round.textContent = data.p1.score || "0";
          p2round.textContent = data.p2.score || "0";
          roundInfo.textContent = "Spied 'Gatavs'";
          winnerLine.textContent = "";
          break;

        case "readyState":
          roundInfo.textContent = `Gatavs: ${data.p1ready ? "P1 " : ""}${data.p2ready ? "P2" : ""}`;
          break;

        case "roundPrepare":
          startCountdown(data.in, "prepare");
          p1move.textContent = "?";
          p2move.textContent = "?";
          winnerLine.textContent = "";
          mustReady.style.display = "none";
          break;

        case "roundStart":
          startCountdown(data.duration || 15, "fight");
          break;

        case "rps-reveal":
          revealMoves(data);
          break;

        case "matchEnd":
          addLog(`Uzvarƒìja ${data.winner} (${data.p1score}:${data.p2score})`);
          roundInfo.textContent = `Maƒçs beidzies!`;
          p1round.textContent = "0";
          p2round.textContent = "0";
          iAmReady = false;
          readyBtn.disabled = true;
          mustReady.style.display = "none";
          break;

        case "opponentLeft":
          showMsg("Pretinieks izgƒÅja. Meklƒìjam jaunu‚Ä¶");
          p2name.textContent = "Gaida...";
          p2move.textContent = "?";
          p2round.textContent = "0";
          winnerLine.textContent = "";
          break;

        case "opponentLastGame":
          showMsg(`${data.name} spƒìlƒì pƒìdƒìjo partiju`);
          break;

        case "opponentAvatar":
          avatar2.style.backgroundImage = `url(${data.avatar})`;
          break;

        case "error":
          showMsg(data.message);
          break;
      }
    }

    function startCountdown(seconds, mode) {
      if (countdownTimer) clearInterval(countdownTimer);
      countdownLeft = seconds;
      updateCountdownText(mode, countdownLeft);
      countdownTimer = setInterval(() => {
        countdownLeft--;
        if (countdownLeft <= 0) {
          clearInterval(countdownTimer);
          countdownTimer = null;
          updateCountdownText(mode, 0);
        } else {
          updateCountdownText(mode, countdownLeft);
        }
      }, 1000);
    }

    function updateCountdownText(mode, s) {
      if (mode === "prepare") roundInfo.textContent = "Raunds sƒÅkas pƒìc " + s + " s";
      else if (mode === "fight") roundInfo.textContent = "Cƒ´≈Üa! (" + s + " s)";
    }

    function renderQueues(rooms) {
      q1.textContent = rooms["1"].length ? rooms["1"].map(x => x.name).join(", ") : "tuk≈°a";
      q2.textContent = rooms["2"].length ? rooms["2"].map(x => x.name).join(", ") : "tuk≈°a";
      q3.textContent = rooms["3"].length ? rooms["3"].map(x => x.name).join(", ") : "tuk≈°a";
      if (!rooms["1"].length) q1.classList.add("queue-empty"); else q1.classList.remove("queue-empty");
      if (!rooms["2"].length) q2.classList.add("queue-empty"); else q2.classList.remove("queue-empty");
      if (!rooms["3"].length) q3.classList.add("queue-empty"); else q3.classList.remove("queue-empty");
    }

    function setP1(p) {
      p1name.textContent = p.name;
      if (p.avatar) avatar1.style.backgroundImage = `url(${p.avatar})`;
      else avatar1.style.backgroundImage = "";
    }
    function setP2(p) {
      p2name.textContent = p.name;
      if (p.avatar) avatar2.style.backgroundImage = `url(${p.avatar})`;
      else avatar2.style.backgroundImage = "";
    }

    function revealMoves(msg) {
      p1move.textContent = emojiFromMove(msg.p1.move);
      p2move.textContent = emojiFromMove(msg.p2.move);
      p1round.textContent = msg.p1.score;
      p2round.textContent = msg.p2.score;

      showFightAnimation(msg.p1.move, msg.p2.move);

      if (msg.winner) {
        showMsg("üéâ " + msg.winner + " uzvarƒìja raundu!");
        winnerLine.textContent = "üéâ " + msg.winner + " uzvarƒìja ≈°o raundu";
        winnerLine.style.color = "#ecfdf3";
      } else {
        showMsg("‚öñ Neiz≈°ƒ∑irts");
        winnerLine.textContent = "‚öñ Neiz≈°ƒ∑irts";
        winnerLine.style.color = "#e2e8f0";
      }
    }

    function emojiFromMove(m) {
      if (m === "rock") return "üóø";
      if (m === "paper") return "üìÑ";
      if (m === "scissors") return "‚úÇÔ∏è";
      return "?";
    }

    function showFightAnimation(move1, move2) {
      fightLeft.style.backgroundImage = iconForMove(move1);
      fightRight.style.backgroundImage = iconForMove(move2);
      fightWrap.className = "fight-wrap";

      fightBox.style.display = "block";
      setTimeout(() => {
        fightBox.style.display = "none";
        fightWrap.className = "fight-wrap";
      }, 1200);
    }

    function iconForMove(move) {
      if (move === "rock") return "url('https://cdn.jsdelivr.net/gh/twitter/twemoji@latest/assets/svg/1f5ff.svg')";
      if (move === "paper") return "url('https://cdn.jsdelivr.net/gh/twitter/twemoji@latest/assets/svg/1f4c4.svg')";
      if (move === "scissors") return "url('https://cdn.jsdelivr.net/gh/twitter/twemoji@latest/assets/svg/2702.svg')";
      return "none";
    }

    document.querySelectorAll(".move-btn").forEach(btn => {
      btn.addEventListener("click", () => {
        const mv = btn.dataset.move;
        if (ws && ws.readyState === WebSocket.OPEN) {
          ws.send(JSON.stringify({ type: "move", move: mv }));
        }
      });
    });

    readyBtn.addEventListener("click", () => {
      if (iAmReady) return;
      if (ws && ws.readyState === WebSocket.OPEN) {
        ws.send(JSON.stringify({ type: "ready" }));
        iAmReady = true;
        readyBtn.disabled = true;
        roundInfo.textContent = "GaidƒÅm otru spƒìlƒìtƒÅju‚Ä¶";
        mustReady.style.display = "none";
      }
    });

    lastBtn.addEventListener("click", () => {
      if (ws && ws.readyState === WebSocket.OPEN) {
        ws.send(JSON.stringify({ type: "lastGame" }));
      }
    });

    function saveNickNow() {
      myName = nickEl.value.trim() || "Bugats";
      localStorage.setItem("rps_name", myName);
      if (ws && ws.readyState === WebSocket.OPEN) {
        ws.send(JSON.stringify({ type: "setName", name: myName }));
      }
      showMsg("Niks saglabƒÅts ‚úÖ");
    }

    document.getElementById("saveNick").addEventListener("click", () => {
      saveNickNow();
    });

    nickEl.addEventListener("keydown", (e) => {
      if (e.key === "Enter") {
        saveNickNow();
        nickEl.blur();
      }
    });

    roomSel.addEventListener("change", () => {
      myRoom = roomSel.value;
      localStorage.setItem("rps_room", myRoom);
      if (ws && ws.readyState === WebSocket.OPEN) {
        ws.send(JSON.stringify({ type: "changeRoom", room: myRoom }));
      }
    });

    avatarFile.addEventListener("change", (ev) => {
      const file = ev.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = () => {
        const base = reader.result;
        myAvatar = base;
        localStorage.setItem("rps_avatar", base);
        avatar1.style.backgroundImage = `url(${base})`;
        if (ws && ws.readyState === WebSocket.OPEN) {
          ws.send(JSON.stringify({ type: "avatarUpload", avatar: base }));
        }
      };
      reader.readAsDataURL(file);
    });

    function renderTop(list) {
      toplistEl.innerHTML = "";
      list.forEach(item => {
        const div = document.createElement("div");
        div.style.display = "flex";
        div.style.justifyContent = "space-between";
        div.style.fontSize = ".78rem";
        div.style.padding = ".25rem 0";
        div.innerHTML = `<span>${item.name}</span><span>${item.score}</span>`;
        toplistEl.appendChild(div);
        if (!myId) {
          myId = item.id;
          localStorage.setItem("rps_id", myId);
        }
      });
    }

    function addLog(text) {
      const d = document.createElement("div");
      d.textContent = text;
      logs.prepend(d);
    }

    function showMsg(t) {
      msg.textContent = t;
      msg.style.display = "block";
      clearTimeout(showMsg._t);
      showMsg._t = setTimeout(() => {
        msg.style.display = "none";
      }, 2500);
    }
  </script>
</body>
</html>

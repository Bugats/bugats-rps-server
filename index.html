<!DOCTYPE html>
<html lang="lv">
<head>
  <meta charset="UTF-8" />
  <title>Bugats RPS (online)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #0f172a;
      --panel: rgba(15,23,42,.65);
      --border: rgba(148,163,184,.25);
      --text: #e2e8f0;
      --accent: #22c55e;
      --danger: #f43f5e;
      --warn: #f97316;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      background: radial-gradient(circle at top, #0f172a 0%, #020617 60%);
      color: var(--text);
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      display: flex;
      min-height: 100vh;
    }
    .wrap {
      display: flex;
      width: 100%;
      gap: 1rem;
      padding: 1rem;
    }
    .left {
      flex: 1.4;
      background: rgba(2,6,23,.4);
      border: 1px solid rgba(148,163,184,.05);
      border-radius: 20px;
      padding: 1rem 1.25rem 1.5rem;
      position: relative;
      overflow: hidden;
    }
    .right {
      width: 320px;
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }
    .card {
      background: rgba(2,6,23,.4);
      border: 1px solid rgba(148,163,184,.05);
      border-radius: 16px;
      padding: 1rem;
    }
    h1 {
      margin: 0 0 .5rem;
      font-size: 1.5rem;
      display: flex;
      align-items: center;
      gap: .5rem;
    }
    .status {
      font-size: .8rem;
      opacity: .7;
    }
    .arena {
      margin-top: .75rem;
      display: flex;
      justify-content: center;
      gap: 2rem;
      align-items: center;
    }
    .player-box {
      width: 180px;
      height: 200px;
      border: 1px solid rgba(148,163,184,.3);
      border-radius: 28px;
      background: radial-gradient(circle at 40% 20%, rgba(148,163,184,.2), rgba(15,23,42,.12));
      text-align: center;
      position: relative;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      gap: .25rem;
      padding-top: .6rem;
    }
    .player-name {
      font-weight: 600;
      margin-top: .25rem;
    }
    .player-avatar {
      position: absolute;
      top: 8px;
      right: 8px;
      width: 44px;
      height: 44px;
      border-radius: 9999px;
      border: 2px solid rgba(255,255,255,.35);
      background: rgba(15,23,42,.4);
      background-size: cover;
      background-position: center;
    }
    .question {
      font-size: 4.2rem;
      line-height: 1;
      margin-top: 1.15rem;
    }
    .score-small {
      margin-top: .35rem;
      font-size: .75rem;
      opacity: .7;
    }
    .vs {
      font-weight: 700;
      font-size: 1.25rem;
      opacity: .85;
    }
    .moves {
      margin-top: 1.3rem;
      display: flex;
      gap: .85rem;
      justify-content: center;
    }
    .move-btn {
      width: 70px;
      height: 70px;
      border-radius: 1.2rem;
      background: rgba(15,23,42,.4);
      border: 1px solid rgba(148,163,184,.18);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: .15s;
    }
    .move-btn:hover {
      background: rgba(148,163,184,.09);
      transform: translateY(-2px);
    }
    .icon-move {
      width: 42px;
      height: 42px;
      background: rgba(15,23,42,.55);
      border: 1px solid rgba(148,163,184,.35);
      border-radius: 14px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.25rem;
    }
    .footer-text {
      margin-top: 1rem;
      text-align: center;
      font-size: .75rem;
      opacity: .7;
    }
    .name-input {
      width: 100%;
      padding: .55rem .7rem;
      border-radius: .7rem;
      border: 1px solid rgba(148,163,184,.22);
      background: rgba(15,23,42,.35);
      color: var(--text);
      outline: none;
    }
    .label-sm { font-size: .75rem; opacity: .65; margin-bottom: .35rem; display:block; }

    /* online / leaderboard */
    .toplist {
      margin-top: .5rem;
    }
    .top-row {
      display: flex;
      justify-content: space-between;
      font-size: .78rem;
      padding: .25rem 0;
      border-bottom: 1px solid rgba(148,163,184,.05);
    }
    .top-row:last-child { border-bottom: none; }

    /* pazi≈Üojumi */
    #msg {
      position: absolute;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(15,23,42,.8);
      border: 1px solid rgba(148,163,184,.25);
      border-radius: 9999px;
      padding: .35rem .85rem;
      font-size: .8rem;
      display: none;
      z-index: 30;
    }

    /* animƒÅcijas pƒÅrklƒÅjums */
    #fight-anim {
      position: absolute;
      top: 105px;
      left: 50%;
      transform: translateX(-50%);
      width: 260px;
      height: 120px;
      pointer-events: none;
      display: none;
      z-index: 20;
    }
    .fight-wrap {
      position: relative;
      width: 100%;
      height: 100%;
    }
    .fight-icon {
      position: absolute;
      top: 20px;
      width: 80px;
      height: 80px;
      background-size: contain;
      background-repeat: no-repeat;
      background-position: center;
      filter: drop-shadow(0 4px 10px rgba(0,0,0,.5));
    }
    .fight-left { left: 0; }
    .fight-right { right: 0; }

    .fight-wrap.paper-over {
      animation: paperOver 1.2s ease forwards;
    }
    @keyframes paperOver {
      0% { }
      40% { }
      100% { }
    }
    .fight-wrap.rock-smash .fight-left,
    .fight-wrap.rock-smash .fight-right {
      animation: smash 1s ease;
    }
    @keyframes smash {
      0% { transform: scale(1); }
      50% { transform: scale(1.25); }
      100% { transform: scale(1); }
    }
    .fight-wrap.scissors-cut .fight-right {
      animation: cut 1.1s ease;
    }
    @keyframes cut {
      0% { transform: rotate(0deg); }
      30% { transform: rotate(-25deg); }
      60% { transform: rotate(12deg); }
      100% { transform: rotate(0deg); }
    }

    .ready-hint {
      text-align:center;
      font-size:.72rem;
      opacity:.7;
      margin-top:.4rem;
    }
    .btn {
      border: none;
      background: rgba(34,197,94,.18);
      color: #ecfdf3;
      padding: .45rem .8rem;
      border-radius: .6rem;
      cursor: pointer;
      font-size:.7rem;
    }
    .btn-danger { background: rgba(244,63,94,.17); }

    .smallflex {
      display:flex;
      gap:.4rem;
      align-items:center;
    }

    @media (max-width: 980px){
      body { display: block; }
      .wrap { flex-direction: column; }
      .right { width: 100%; }
      .arena { flex-direction: column; }
      .player-box { width: 70%; max-width: 280px; }
      #fight-anim { top: 160px; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="left">
      <h1>Bugats RPS <span id="status" class="status">(nav savienojuma)</span></h1>

      <div id="fight-anim">
        <div class="fight-wrap" id="fight-wrap">
          <div class="fight-icon fight-left" id="fight-left"></div>
          <div class="fight-icon fight-right" id="fight-right"></div>
        </div>
      </div>

      <div class="arena">
        <div class="player-box" id="p1box">
          <div class="player-avatar" id="avatar1"></div>
          <div class="player-name" id="p1name">Gaida...</div>
          <div class="question" id="p1move">?</div>
          <div class="score-small">0</div>
        </div>
        <div class="vs" id="vslabel">VS</div>
        <div class="player-box" id="p2box">
          <div class="player-avatar" id="avatar2"></div>
          <div class="player-name" id="p2name">Gaida...</div>
          <div class="question" id="p2move">?</div>
          <div class="score-small">0</div>
        </div>
      </div>

      <div class="moves">
        <div class="move-btn" data-move="rock">
          <div class="icon-move">üóø</div>
        </div>
        <div class="move-btn" data-move="paper">
          <div class="icon-move">üìÑ</div>
        </div>
        <div class="move-btn" data-move="scissors">
          <div class="icon-move">‚úÇÔ∏è</div>
        </div>
      </div>

      <div class="ready-hint">
        <button id="readyBtn" class="btn">Es esmu gatavs ‚úÖ</button>
        <button id="lastBtn" class="btn btn-danger">PƒìdƒìjƒÅ partija</button>
        <span id="roundInfo"></span>
      </div>

      <div class="footer-text" id="footerText">
        Piemƒìrs: pirmais lƒ´dz 2 uzvarƒÅm (best of 3)
      </div>

      <div id="msg"></div>
    </div>

    <div class="right">
      <div class="card">
        <label class="label-sm">Mans niks</label>
        <input id="nick" class="name-input" placeholder="Bugats" />
        <small style="opacity:.6;font-size:.7rem;">Mainƒ´t saprƒÅtƒ´gi üòâ (serveris atceras)</small>
      </div>

      <div class="card">
        <div class="smallflex">
          <div style="flex:1;">TOP</div>
          <div id="onlineInfo" style="font-size:.7rem;opacity:.6;">Online: 0</div>
        </div>
        <div class="toplist" id="toplist"></div>
      </div>

      <div class="card">
        <div class="smallflex" style="margin-bottom:.5rem;">
          <div style="flex:1;">Istabas</div>
          <select id="roomSel">
            <option value="1">Istaba 1</option>
            <option value="2">Istaba 2</option>
            <option value="3">Istaba 3</option>
          </select>
        </div>
        <label class="label-sm">AvatƒÅrs (bildƒ´te)</label>
        <input type="file" id="avatarFile" accept="image/*" />
      </div>

      <div class="card">
        <div style="font-size:.75rem;opacity:.5;">Pƒìdƒìjie maƒçi (tikai lokƒÅli)</div>
        <div id="logs" style="font-size:.72rem;margin-top:.4rem;max-height:140px;overflow:auto;"></div>
      </div>
    </div>
  </div>

  <script>
    // IMPORTANT: nomaini uz savu Render WS adresi
    const WS_URL = "wss://bugats-rps.onrender.com";

    let ws;
    let myId = localStorage.getItem("rps_id") || null;
    let myName = localStorage.getItem("rps_name") || "Bugats";
    let myRoom = localStorage.getItem("rps_room") || "1";
    let myAvatar = localStorage.getItem("rps_avatar") || null;

    const statusEl = document.getElementById("status");
    const nickEl = document.getElementById("nick");
    const toplistEl = document.getElementById("toplist");
    const onlineInfoEl = document.getElementById("onlineInfo");
    const roomSel = document.getElementById("roomSel");
    const avatarFile = document.getElementById("avatarFile");

    const p1name = document.getElementById("p1name");
    const p2name = document.getElementById("p2name");
    const p1move = document.getElementById("p1move");
    const p2move = document.getElementById("p2move");
    const p1box = document.getElementById("p1box");
    const p2box = document.getElementById("p2box");
    const roundInfo = document.getElementById("roundInfo");
    const readyBtn = document.getElementById("readyBtn");
    const lastBtn = document.getElementById("lastBtn");
    const logs = document.getElementById("logs");
    const avatar1 = document.getElementById("avatar1");
    const avatar2 = document.getElementById("avatar2");
    const msg = document.getElementById("msg");

    const fightBox = document.getElementById("fight-anim");
    const fightWrap = document.getElementById("fight-wrap");
    const fightLeft = document.getElementById("fight-left");
    const fightRight = document.getElementById("fight-right");

    nickEl.value = myName;
    roomSel.value = myRoom;

    function connect() {
      ws = new WebSocket(WS_URL);
      ws.onopen = () => {
        statusEl.textContent = "(savienots, gaida pretinieku)";
        ws.send(JSON.stringify({
          type: "hello",
          id: myId,
          name: myName,
          room: myRoom,
          avatar: myAvatar
        }));
      };
      ws.onclose = () => {
        statusEl.textContent = "(atvienots)";
        setTimeout(connect, 2500);
      };
      ws.onmessage = (ev) => {
        const data = JSON.parse(ev.data);
        handleMsg(data);
      };
    }
    connect();

    function handleMsg(data) {
      switch (data.type) {
        case "online":
          onlineInfoEl.textContent = `Online: ${data.total} | 1:${data.rooms["1"]} 2:${data.rooms["2"]} 3:${data.rooms["3"]}`;
          break;

        case "leaderboard":
          renderTop(data.list);
          break;

        case "waiting":
          showMsg("Gaida pretinieku istabƒÅ " + data.room);
          p1name.textContent = "Gaida...";
          p2name.textContent = "Gaida...";
          p1move.textContent = "?";
          p2move.textContent = "?";
          break;

        case "matchStart":
          showMsg("Atrada pretinieku istabƒÅ " + data.room);
          setP1(data.p1);
          setP2(data.p2);
          roundInfo.textContent = "Abiem jƒÅspie≈æ 'Gatavs'";
          break;

        case "readyState":
          roundInfo.textContent = `Gatavs: ${data.p1ready ? "P1" : ""} ${data.p2ready ? "P2" : ""}`;
          break;

        case "roundPrepare":
          roundInfo.textContent = "Raunds sƒÅkas pƒìc " + data.in + " s";
          break;

        case "roundStart":
          roundInfo.textContent = "Cƒ´≈Üa! (15 s)";
          p1move.textContent = "?";
          p2move.textContent = "?";
          break;

        case "rps-show":
          // var ielikt "show" animƒÅciju, bet pietiek arƒ´ te
          break;

        case "rps-reveal":
          revealMoves(data);
          break;

        case "needReadyAgain":
          roundInfo.textContent = "Spied 'Gatavs' nƒÅkamajam raundam";
          break;

        case "matchEnd":
          addLog(`Uzvarƒìja ${data.winner} (${data.p1score}:${data.p2score})`);
          roundInfo.textContent = `Maƒçs beidzies! Jauns meklƒìsies pƒìc 15s`;
          break;

        case "opponentLeft":
          showMsg("Pretinieks izgƒÅja. Meklƒìjam jaunu‚Ä¶");
          p2name.textContent = "Gaida...";
          p2move.textContent = "?";
          break;

        case "opponentLastGame":
          showMsg(`${data.name} spƒìlƒì pƒìdƒìjo partiju`);
          break;

        case "blockedSelf":
          showMsg("Nevar spƒìlƒìt ar sevi üòé");
          break;

        case "kicked":
          showMsg("Izmests: " + data.reason);
          break;

        case "opponentAvatar":
          avatar2.style.backgroundImage = `url(${data.avatar})`;
          break;

        case "error":
          showMsg(data.message);
          break;
      }
    }

    function setP1(p) {
      p1name.textContent = p.name;
      p1move.textContent = "?";
      if (p.avatar) {
        avatar1.style.backgroundImage = `url(${p.avatar})`;
      } else {
        avatar1.style.backgroundImage = "";
      }
    }
    function setP2(p) {
      p2name.textContent = p.name;
      p2move.textContent = "?";
      if (p.avatar) {
        avatar2.style.backgroundImage = `url(${p.avatar})`;
      } else {
        avatar2.style.backgroundImage = "";
      }
    }

    function revealMoves(msg) {
      p1move.textContent = emojiFromMove(msg.p1.move);
      p2move.textContent = emojiFromMove(msg.p2.move);

      // ANIMƒÄCIJA
      showFightAnimation(msg.p1.move, msg.p2.move, msg.winner);

      if (msg.winner) {
        showMsg("üéâ " + msg.winner + " uzvarƒìja raundu!");
      } else {
        showMsg("‚öñ Neiz≈°ƒ∑irts");
      }
    }

    function emojiFromMove(m) {
      if (m === "rock") return "üóø";
      if (m === "paper") return "üìÑ";
      if (m === "scissors") return "‚úÇÔ∏è";
      return "?";
    }

    // animƒÅcija
    function showFightAnimation(move1, move2, winnerName) {
      fightLeft.style.backgroundImage = iconForMove(move1);
      fightRight.style.backgroundImage = iconForMove(move2);
      fightWrap.className = "fight-wrap";

      if (move1 === move2) {
        // neiz≈°ƒ∑irts
      } else if (move1 === "paper" && move2 === "rock" || move2 === "paper" && move1 === "rock") {
        fightWrap.classList.add("paper-over");
      } else if (move1 === "rock" && move2 === "scissors" || move2 === "rock" && move1 === "scissors") {
        fightWrap.classList.add("rock-smash");
      } else if (move1 === "scissors" && move2 === "paper" || move2 === "scissors" && move1 === "paper") {
        fightWrap.classList.add("scissors-cut");
      }

      fightBox.style.display = "block";
      setTimeout(() => {
        fightBox.style.display = "none";
        fightWrap.className = "fight-wrap";
      }, 1200);
    }

    function iconForMove(move) {
      if (move === "rock") return "url('https://cdn.jsdelivr.net/gh/twitter/twemoji@latest/assets/svg/1f5ff.svg')";
      if (move === "paper") return "url('https://cdn.jsdelivr.net/gh/twitter/twemoji@latest/assets/svg/1f4c4.svg')";
      if (move === "scissors") return "url('https://cdn.jsdelivr.net/gh/twitter/twemoji@latest/assets/svg/2702.svg')";
      return "none";
    }

    // pogas
    document.querySelectorAll(".move-btn").forEach(btn => {
      btn.addEventListener("click", () => {
        const mv = btn.dataset.move;
        if (ws && ws.readyState === WebSocket.OPEN) {
          ws.send(JSON.stringify({ type: "move", move: mv }));
        }
      });
    });

    readyBtn.addEventListener("click", () => {
      if (ws && ws.readyState === WebSocket.OPEN) {
        ws.send(JSON.stringify({ type: "ready" }));
      }
    });

    lastBtn.addEventListener("click", () => {
      if (ws && ws.readyState === WebSocket.OPEN) {
        ws.send(JSON.stringify({ type: "lastGame" }));
      }
    });

    nickEl.addEventListener("change", () => {
      myName = nickEl.value.trim() || "Bugats";
      localStorage.setItem("rps_name", myName);
      if (ws && ws.readyState === WebSocket.OPEN) {
        ws.send(JSON.stringify({ type: "setName", name: myName }));
      }
    });

    roomSel.addEventListener("change", () => {
      myRoom = roomSel.value;
      localStorage.setItem("rps_room", myRoom);
      if (ws && ws.readyState === WebSocket.OPEN) {
        ws.send(JSON.stringify({ type: "changeRoom", room: myRoom }));
      }
    });

    avatarFile.addEventListener("change", (ev) => {
      const file = ev.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = () => {
        const base = reader.result;
        myAvatar = base;
        localStorage.setItem("rps_avatar", base);
        avatar1.style.backgroundImage = `url(${base})`;
        if (ws && ws.readyState === WebSocket.OPEN) {
          ws.send(JSON.stringify({ type: "avatarUpload", avatar: base }));
        }
      };
      reader.readAsDataURL(file);
    });

    function renderTop(list) {
      toplistEl.innerHTML = "";
      list.forEach(item => {
        const div = document.createElement("div");
        div.className = "top-row";
        div.innerHTML = `<span>${item.name}</span><span>${item.score}</span>`;
        toplistEl.appendChild(div);
        if (!myId) {
          // iedodam pirmo ID
          myId = item.id;
          localStorage.setItem("rps_id", myId);
        }
      });
    }

    function addLog(text) {
      const d = document.createElement("div");
      d.textContent = text;
      logs.prepend(d);
    }

    function showMsg(t) {
      msg.textContent = t;
      msg.style.display = "block";
      clearTimeout(showMsg._t);
      showMsg._t = setTimeout(() => {
        msg.style.display = "none";
      }, 2500);
    }
  </script>
</body>
</html>
